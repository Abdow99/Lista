<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anesthesia Theater Coordinator Pro</title>
    <meta name="theme-color" content="#1a1a1a">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { 
            --primary: #ef233c;       
            --bg: #1a1a1a;            
            --card-bg: #ffffff;
            --dark-card: #2b2b2b;
            --input-bg: #f8f9fa;
            --text-main: #2b2d42;
            --text-light: #f8f9fa;    
            --highlight: #ffd166;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);
            --border-radius: 12px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-light); 
            margin: 0; 
            padding: 20px 0; 
        }

        .container { width: 95%; max-width: 750px; margin: 0 auto; padding-bottom: 80px; }

        /* HEADER */
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMS - Bright Styling */
        .card { 
            background: var(--card-bg); 
            color: var(--text-main);
            border-radius: var(--border-radius); 
            padding: 20px; 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; 
            background: var(--input-bg); color: #333; font-size: 1rem; box-sizing: border-box; 
        }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: 800; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: #4361ee; }
        .btn-success { background: #2a9d8f; }
        .btn-danger { background: #d90429; }
        .btn-nurse { background: #f77f00; }
        button:active { transform: scale(0.98); }

        /* VIEWS */
        .view-section { display: none; }
        .active-view { display: block; }

        /* PATIENT CARD DESIGN */
        .patient-card { 
            background: #ffffff; 
            color: #2b2d42; 
            border-radius: 10px; 
            margin-bottom: 30px; 
            overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            /* No page-break forced here, handled by JS for perfect fit */
        }
        .pc-header { 
            background: #e9ecef; padding: 10px 15px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: center;
        }
        .pc-num { font-weight: 900; font-size: 1.2rem; color: var(--primary); }
        .pc-actions button { padding: 5px 10px; font-size: 0.7rem; margin-left: 5px; }
        
        .pc-body { padding: 15px; }
        
        .highlight-data { font-size: 1.1rem; font-weight: 900; color: #000; margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .highlight-val { color: var(--primary); background: #fff3cd; padding: 0 4px; border-radius: 4px; }

        /* UPDATED NOTES & REQUESTS STYLING */
        .tags-wrapper { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 5px; }
        .tag-note { 
            background: #ffe5e5; color: #d00000; padding: 4px 8px; 
            border-radius: 6px; font-size: 0.85rem; font-weight: 700; border: 1px solid #ffccd5;
        }
        .tag-req { 
            background: #e0fbfc; color: #0077b6; padding: 4px 8px; 
            border-radius: 6px; font-size: 0.85rem; font-weight: 700; border: 1px solid #caf0f8;
        }

        /* CLINICAL GRIDS */
        .section-title { font-size: 0.8rem; font-weight: 800; color: #555; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 2px solid var(--primary); display: inline-block; }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
        .data-box { background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #dee2e6; }
        .lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; font-weight: 700; }
        .val { font-size: 0.95rem; font-weight: 800; color: #2b2d42; }
        .drops-text { font-size: 0.65rem; color: #e76f51; font-weight: 700; display: block; font-style: italic; }

        /* DRUG TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85rem; }
        th { text-align: left; font-size: 0.65rem; color: #666; background: #e9ecef; padding: 6px; text-transform: uppercase; }
        td { padding: 8px 4px; border-bottom: 1px solid #f1f3f5; color: #222; }
        .drug-name { font-weight: 800; display: block; }
        .drug-prep { font-size: 0.7rem; color: #666; }
        .vol-col { font-weight: 900; color: var(--primary); text-align: right; }
        
        /* Badges */
        .w-badge { font-size: 0.55rem; padding: 1px 4px; border-radius: 3px; font-weight: 800; margin-left: 4px; text-transform: uppercase; display: inline-block; }
        .w-tbw { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
        .w-ibw { background: #e0fbfc; color: #0077b6; border: 1px solid #caf0f8; }
        .w-fixed { background: #f3e5f5; color: #7b1fa2; }
        
        .cat-row td { background: #f8f9fa; color: #2b2d42; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; padding: 4px 8px; border-left: 3px solid var(--primary); margin-top: 5px; }

        /* FINAL LIST HEADER */
        #final-list-header { background: #fff; color: #000; padding: 20px; text-align: center; border-bottom: 4px solid var(--primary); display: none; }
        #final-list-header h2 { margin: 0; font-size: 1.8rem; color: var(--primary); text-transform: uppercase; }
        #final-list-header p { margin: 5px 0 0 0; font-weight: 600; color: #555; }

        /* DISCLAIMER FOOTER */
        .app-footer {
            margin-top: 30px;
            padding: 15px;
            background: #fff;
            color: #666;
            font-size: 0.7rem;
            text-align: center;
            border-top: 1px solid #ddd;
            border-radius: 8px;
        }
        .app-footer a { color: var(--primary); text-decoration: none; font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Theater Coordinator</h1>
        <div id="status-bar" style="font-size: 0.8rem; color: #aaa;">Step 1: List Setup</div>
    </header>

    <div id="view-setup" class="view-section active-view">
        <div class="card">
            <div class="form-group">
                <label>List Name / Theater</label>
                <input type="text" id="listName" placeholder="e.g. OR 1 - General Surgery">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="listDate">
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Surgeons</label>
                        <input type="text" id="surgeons" placeholder="Dr. X, Dr. Y">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Anesthesiologists</label>
                        <input type="text" id="anesthetists" placeholder="Dr. Z">
                    </div>
                </div>
            </div>
            <button class="btn-primary" onclick="goToInput()">Start List</button>
        </div>
    </div>

    <div id="view-input" class="view-section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="font-size:1rem;">Patient Details</label>
                <span id="edit-indicator" style="color:var(--highlight); font-size:0.8rem; display:none;">EDITING MODE</span>
            </div>
            
            <input type="hidden" id="pId"> 
            <div class="form-group">
                <label>Patient Name</label>
                <input type="text" id="pName">
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Age (Y)</label>
                        <input type="number" id="pAge" step="0.1" onchange="estimateWeight()">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="pWeight" step="0.1" placeholder="Auto-Est if empty">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Operation</label>
                <input type="text" id="pOp">
            </div>
            <div class="form-group">
                <label>Anesthesia Type</label>
                <select id="pType">
                    <option value="GA">General Anesthesia (GA)</option>
                    <option value="Spinal">Spinal</option>
                    <option value="Regional/Block">Regional / Nerve Block</option>
                    <option value="Sedation">Sedation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Additive Nerve Block</label>
                <select id="pNerve">
                    <option value="None">None</option>
                    <option value="Interscalene">Interscalene</option>
                    <option value="Supraclav">Supraclav.</option>
                    <option value="Infraclav">Infraclav.</option>
                    <option value="Axillary">Axillary</option>
                    <option value="Tap">Tap</option>
                    <option value="ESP">ESP</option>
                    <option value="Serratus">Serratus</option>
                    <option value="Illiacus">Illiacus</option>
                    <option value="Femoro-sciatic">Femoro-sciatic</option>
                    <option value="Femoro-popliteal">Femoro-popliteal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Positive Data / Allergies / Notes</label>
                <textarea id="pNotes" placeholder="Hb 8, Htn, Dm on insulin..."></textarea>
            </div>
            <div class="form-group">
                <label>Requests (Blood, Plasma, ICU, etc)</label>
                <input type="text" id="pRequests" placeholder="blood, plasma, ICU...">
            </div>

            <div class="btn-group">
                <button class="btn-secondary" id="btnAddParam" onclick="addPatient()">‚ûï Add to List</button>
                <button class="btn-success" onclick="generateView()">‚úÖ Finish & View List</button>
            </div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#888; margin-top:10px;">
            Current Patients: <span id="count-badge" style="color:white; font-weight:bold;">0</span>
        </div>
    </div>

    <div id="view-output" class="view-section">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-primary" onclick="goToInput()">‚ûï Add More</button>
            <button class="btn-danger" onclick="location.reload()">üîÑ Reset All</button>
        </div>

        <div id="capture-area" style="background: #ffffff; padding: 0; border-radius: 5px;">
            
            <div id="final-list-header">
                <h2 id="out-list-name">Theater List</h2>
                <p><span id="out-date"></span> | <span id="out-team"></span></p>
                <p style="font-size:0.9rem; margin-top:5px; color:#ef233c;">Total Patients: <span id="out-count">0</span></p>
            </div>

            <div id="list-container" style="padding: 10px;"></div>

            <div class="app-footer">
                <p style="margin: 0 0 5px 0; font-weight: bold;">MEDICAL DISCLAIMER</p>
                <p style="margin: 0 0 10px 0; font-style: italic;">
                    This list was made by Lista app and it is for organizing the theater and calculations aid for healthcare professionals. 
                    Verify all the data of patients and all doses according to local protocols. 
                    The developer is not responsible for clinical errors.
                </p>
                <p style="margin: 0;">
                    Feedback: 
                    <a href="https://wa.me/201550086024" target="_blank">Dr. Abdow Whatsapp: +201550086024</a>
                </p>
            </div>
        </div>

        <div class="card" style="margin-top:20px; background: #2b2b2b; color:white;">
            <label>Saving Options</label>
            <div class="btn-group">
                <button class="btn-primary" onclick="downloadPDF()">üìÑ Save as PDF (Full Anesthesia)</button>
            </div>
            <div class="btn-group" style="margin-top:10px;">
                <button class="btn-nurse" onclick="saveImage('nurse')">üì∏ Save Management Photo</button>
            </div>
            <p style="font-size:0.7rem; color:#aaa; text-align:center; margin-top:5px;">
                "Management" version hides drugs, fluids & airway details.
            </p>
        </div>
    </div>
</div>

<script>
    // --- HELPERS ---
    // Format number to remove trailing zeros (e.g. 140.00 -> 140)
    function fmtNum(n) {
        return parseFloat(n.toFixed(2));
    }

    // --- DATA STORE ---
    let listMeta = { name: "", date: "", surgeons: "", anesthetists: "" };
    let patients = [];
    let editMode = false;

    // --- INIT ---
    window.onload = function() {
        const tmr = new Date();
        tmr.setDate(tmr.getDate() + 1); 
        document.getElementById('listDate').valueAsDate = tmr;
    };

    // --- NAVIGATION ---
    function goToInput() {
        listMeta.name = document.getElementById('listName').value || "Theater List";
        listMeta.date = document.getElementById('listDate').value;
        listMeta.surgeons = document.getElementById('surgeons').value;
        listMeta.anesthetists = document.getElementById('anesthetists').value;

        document.getElementById('view-setup').classList.remove('active-view');
        document.getElementById('view-output').classList.remove('active-view');
        document.getElementById('view-input').classList.add('active-view');
        document.getElementById('status-bar').innerText = "Step 2: Add Patients";
        
        if(!editMode) clearForm();
    }

    function estimateWeight() {
        const age = parseFloat(document.getElementById('pAge').value);
        if(!age && age !== 0) return;
        let w = 0;
        if (age < 1) w = (age * 12 + 9) / 2; 
        else if (age <= 8) w = (age * 2) + 8;
        else if (age < 18) w = (age * 3) + 7;
        else w = 70;
        document.getElementById('pWeight').placeholder = `Est: ${w.toFixed(1)} kg`;
    }

    function clearForm() {
        document.getElementById('pId').value = "";
        document.getElementById('pName').value = "";
        document.getElementById('pAge').value = "";
        document.getElementById('pWeight').value = "";
        document.getElementById('pOp').value = "";
        document.getElementById('pNerve').value = "None";
        document.getElementById('pRequests').value = "";
        document.getElementById('pNotes').value = "";
        document.getElementById('pWeight').placeholder = "Auto-Est if empty";
        document.getElementById('btnAddParam').innerText = "‚ûï Add to List";
        document.getElementById('btnAddParam').classList.remove('btn-success');
        document.getElementById('btnAddParam').classList.add('btn-secondary');
        document.getElementById('edit-indicator').style.display = 'none';
        editMode = false;
    }

    // --- CRUD OPERATIONS ---
    function addPatient() {
        const idVal = document.getElementById('pId').value;
        const name = document.getElementById('pName').value;
        const age = parseFloat(document.getElementById('pAge').value);
        let weight = parseFloat(document.getElementById('pWeight').value);
        const op = document.getElementById('pOp').value;
        const type = document.getElementById('pType').value;
        const nerve = document.getElementById('pNerve').value;
        const req = document.getElementById('pRequests').value;
        const notes = document.getElementById('pNotes').value;

        if(!name || isNaN(age) || !op) {
            alert("Name, Age, and Operation are required.");
            return;
        }

        let estimated = false;
        if (!weight) {
            estimated = true;
            if (age < 1) weight = (age * 12 + 9) / 2; 
            else if (age <= 8) weight = (age * 2) + 8;
            else if (age < 18) weight = (age * 3) + 7;
            else weight = 70;
        }

        const pObj = {
            id: idVal ? parseInt(idVal) : Date.now(),
            name, age, weight, estimated, op, type, nerve, req, notes
        };

        if(editMode && idVal) {
            const idx = patients.findIndex(p => p.id == idVal);
            if(idx !== -1) patients[idx] = pObj;
            editMode = false;
        } else {
            patients.push(pObj);
        }

        clearForm();
        document.getElementById('count-badge').innerText = patients.length;
        document.getElementById('pName').focus();
    }

    function deletePatient(id) {
        if(confirm("Delete this patient?")) {
            patients = patients.filter(p => p.id !== id);
            generateView(); 
        }
    }

    function editPatient(id) {
        const p = patients.find(obj => obj.id === id);
        if(!p) return;
        
        editMode = true;
        document.getElementById('view-output').classList.remove('active-view');
        document.getElementById('view-input').classList.add('active-view');

        document.getElementById('pId').value = p.id;
        document.getElementById('pName').value = p.name;
        document.getElementById('pAge').value = p.age;
        document.getElementById('pWeight').value = p.weight;
        document.getElementById('pOp').value = p.op;
        document.getElementById('pType').value = p.type;
        document.getElementById('pNerve').value = p.nerve;
        document.getElementById('pRequests').value = p.req;
        document.getElementById('pNotes').value = p.notes;
        
        document.getElementById('btnAddParam').innerText = "üíæ Update Patient";
        document.getElementById('btnAddParam').classList.remove('btn-secondary');
        document.getElementById('btnAddParam').classList.add('btn-success');
        document.getElementById('edit-indicator').style.display = 'inline';
    }

    // --- LOGIC ENGINE ---
    function getDripRate(mlPerHour) {
        if (!mlPerHour || mlPerHour <= 0) return "--";
        const dropsPerSec = (mlPerHour * 15) / 3600;
        if (dropsPerSec >= 1) return `${dropsPerSec.toFixed(1)} drops/s`;
        else return `1 drop / ${(1/dropsPerSec).toFixed(0)}s`;
    }

    function calculate(p) {
        const w = p.weight;
        const age = p.age;
        
        let ibw = 70;
        if (age < 1) ibw = (age * 12 + 9) / 2;
        else if (age <= 8) ibw = (age * 2) + 8;
        else if (age < 18) ibw = (age * 3) + 7;
        
        const isObese = (w > ibw * 1.3 && age >= 12);
        const abw = isObese ? (ibw + 0.4 * (w - ibw)) : w;
        
        const w_ind = isObese ? abw : w;
        const w_nmb = isObese ? ibw : w;

        // Airway
        let ettVal, bladeText;
        if (age < 0.1) { ettVal = "2.5"; bladeText = "Miller 0"; }
        else if (age < 0.5) { ettVal = "3.0"; bladeText = "Miller 0/1"; }
        else if (age < 1.0) { ettVal = "3.5"; bladeText = "Mac 1"; }
        else if (age < 2.0) { ettVal = "4.0"; bladeText = "Mac 1/2"; }
        else if (age <= 10.0) { ettVal = ((age/4)+4).toFixed(1); bladeText = "Mac 2/3"; }
        else if (age < 18.0) { ettVal = "6.5-7.0"; bladeText = "Mac 3"; }
        else { ettVal = "7.0(F) / 7.5(M)"; bladeText = "Mac 3/4"; }

        let depthVal = (age < 1) ? (w + 6).toFixed(1) : (age >= 18 ? "21-23" : (((age/4)+4)*3).toFixed(0));

        // Fluid Logic
        let maint = (w <= 10) ? (w * 4) : (w <= 20 ? (40 + (w-10)*2) : (60 + (w-20)));
        let deficit = maint * 6;
        let rate1st = maint + (deficit * 0.5); 
        let rate2nd = maint + (deficit * 0.25); 
        let rate3rd = maint + (deficit * 0.25); 

        // Drugs Logic
        let drugs = [];
        const isSedation = p.type === 'Sedation';

        // Propofol
        let pFactor = isSedation ? 1.0 : (age < 12 ? 3 : 2);
        let pDose = (isSedation ? w : (age < 12 ? w : w_ind)) * pFactor;
        let pLabel = isSedation ? "Propofol (Sedation)" : "Propofol";
        drugs.push({cat: "Induction", name: pLabel, prep: "10mg/mL", dose: pDose, unit: "mg", ml: pDose/10, badge: isSedation ? "TBW" : (age<12?"TBW":"ABW")});

        // NMB & Fentanyl
        drugs.push({cat: "Induction", name: "Fentanyl", prep: "10mcg/mL", dose: w*1.5, unit: "mcg", ml: (w*1.5)/10, badge: "TBW"});
        drugs.push({cat: "Induction", name: "Atracurium", prep: "5mg/mL", dose: w_nmb*0.5, unit: "mg", ml: (w_nmb*0.5)/5, badge: isObese?"IBW":"TBW"});
        drugs.push({cat: "Induction", name: "Rocuronium", prep: "10mg/mL", dose: w_nmb*0.6, unit: "mg", ml: (w_nmb*0.6)/10, badge: isObese?"IBW":"TBW"});
        
        // Sugammadex (Diluted 100mg/10ml -> 10mg/ml)
        drugs.push({cat: "Induction", name: "Sugammadex", prep: "100mg/10mL", dose: w_nmb*2, unit: "mg", ml: (w_nmb*2)/10, badge: "IBW"});

        // Co-Analgesia
        // Dexamethasone (Diluted 4mg/10ml -> 0.4mg/ml)
        let dexDose = (age >= 18) ? 8 : Math.min(w*0.15, 10);
        drugs.push({cat: "Co-Analgesia", name: "Dexamethasone", prep: "4mg/10mL", dose: dexDose, unit: "mg", ml: dexDose/0.4, badge: "Fixed"});
        
        let paraDose = Math.min(w*15, 1000);
        drugs.push({cat: "Co-Analgesia", name: "Paracetamol", prep: "10mg/mL", dose: paraDose, unit: "mg", ml: paraDose/10, badge: "TBW"});

        // Reversal / Emergency
        let neoDose = Math.min(ibw*0.05, 5);
        drugs.push({cat: "Reversal", name: "Neostigmine", prep: "2.5mg/10mL", dose: neoDose, unit: "mg", ml: neoDose/0.25, badge: "IBW"});
        
        // Atropine moved to Emergency, Adrenaline removed
        let ephDose = Math.min(ibw*0.1, 6);
        drugs.push({cat: "Emergency", name: "Ephedrine", prep: "3mg/mL (Diluted)", dose: ephDose, unit: "mg", ml: ephDose/3, badge: "Max IBW"});
        
        // Atropine
        drugs.push({cat: "Emergency", name: "Atropine", prep: "0.1mg/mL", dose: Math.max(neoDose*0.4, 0.1), unit: "mg", ml: (Math.max(neoDose*0.4, 0.1))/0.1, badge: "Mix"});

        // --- FILTERING LOGIC ---
        // If Spinal: Remove specific drugs
        if (p.type === 'Spinal') {
            const blocked = ['Propofol', 'Atracurium', 'Rocuronium', 'Neostigmine', 'Sugammadex'];
            drugs = drugs.filter(d => !blocked.includes(d.name) && !d.name.includes('Propofol'));
        } 
        
        // Limits
        let lidoMax = ibw * 3;
        let marcMax = ibw * 2;

        return {
            ett: ettVal, blade: bladeText, depth: depthVal,
            maint, rate1st, rate2nd, rate3rd,
            drugs,
            lidoMax, marcMax
        };
    }

    // --- VIEW GENERATION ---
    function generateView() {
        document.getElementById('view-input').classList.remove('active-view');
        document.getElementById('view-output').classList.add('active-view');

        patients.sort((a, b) => {
            let sA = 0, sB = 0;
            if(a.age < 12) sA += 10;
            if(b.age < 12) sB += 10;
            if((a.notes+a.req).toLowerCase().includes('allergy')) sA += 5;
            if((b.notes+b.req).toLowerCase().includes('allergy')) sB += 5;
            return sB - sA;
        });

        document.getElementById('final-list-header').style.display = 'block';
        document.getElementById('out-list-name').innerText = listMeta.name;
        document.getElementById('out-date').innerText = listMeta.date;
        document.getElementById('out-team').innerText = `Surgeons: ${listMeta.surgeons} | Anesthesia: ${listMeta.anesthetists}`;
        document.getElementById('out-count').innerText = patients.length;

        const cont = document.getElementById('list-container');
        cont.innerHTML = "";

        patients.forEach((p, idx) => {
            const calcs = calculate(p);
            
            // NOTE & REQUEST TAGS
            let noteHtml = p.notes.split(',').filter(x=>x.trim()).map(n => `<span class="tag-note">${n.trim()}</span>`).join('');
            let reqHtml = p.req.split(',').filter(x=>x.trim()).map(r => `<span class="tag-req">${r.trim()}</span>`).join('');

            // Drug Rows
            let lastCat = "";
            let drugRows = calcs.drugs.map(d => {
                let catHeader = "";
                if (d.cat !== lastCat) {
                    catHeader = `<tr class="cat-row"><td colspan="3">${d.cat}</td></tr>`;
                    lastCat = d.cat;
                }
                return `${catHeader}
                <tr>
                    <td><span class="drug-name">${d.name}</span> <span class="drug-prep">${d.prep}</span></td>
                    <td>${fmtNum(d.dose)} ${d.unit} <span class="w-badge w-${d.badge.toLowerCase().includes('ibw')?'ibw':'tbw'}">${d.badge}</span></td>
                    <td class="vol-col">${fmtNum(d.ml)} mL</td>
                </tr>`;
            }).join('');

            let safetyHtml = `
            <div style="margin-top:5px; font-size:0.75rem; background:#fff0f3; padding:5px; border-radius:4px; border:1px solid #ffccd5;">
                <strong>‚ö†Ô∏è Max Safety Limits (IBW):</strong> 
                Lidocaine: ${fmtNum(calcs.lidoMax)}mg | Marcaine: ${fmtNum(calcs.marcMax)}mg
            </div>`;

            // NERVE BLOCK HIGHLIGHT
            let blockHtml = "";
            if(p.nerve && p.nerve !== 'None') {
                let safeMaxBupi = (2 * p.weight); 
                let safeMaxVol = safeMaxBupi / 5;
                blockHtml = `
                <div style="background:#e0fbfc; padding:10px; margin-top:10px; border:2px solid #0077b6; border-radius:8px; color:#0077b6;">
                    <strong style="font-size:0.9rem;">üìç BLOCK: ${p.nerve}</strong><br>
                    <span style="font-size:0.8rem; color:#023e8a;">Recommended Bupivacaine 0.5%:</span> 
                    <span style="font-weight:900; font-size:1rem; color:#ef233c;">Max ${fmtNum(safeMaxVol)} ml (${fmtNum(safeMaxBupi)}mg)</span>
                </div>`;
            }

            const html = `
            <div class="patient-card">
                <div class="pc-header">
                    <div>
                        <span class="pc-num">#${idx+1}</span> 
                        <span style="font-weight:800; font-size:1.1rem; margin-left:8px;">${p.name}</span>
                    </div>
                    <div class="pc-actions" data-html2canvas-ignore>
                        <button class="btn-secondary" onclick="editPatient(${p.id})">EDIT</button>
                        <button class="btn-danger" onclick="deletePatient(${p.id})">DEL</button>
                    </div>
                </div>
                
                <div class="pc-body">
                    <div class="highlight-data">
                        <span class="highlight-val">${p.age} Y</span> | 
                        <span class="highlight-val">${fmtNum(p.weight)} kg ${p.estimated?'(Est)':''}</span> | 
                        <span style="color:#ef233c;">${p.op}</span>
                        <div style="font-size:0.8rem; color:#555; margin-top:4px;">${p.type}</div>
                    </div>

                    <div class="tags-wrapper">
                        ${noteHtml}
                    </div>
                    <div class="tags-wrapper">
                        ${reqHtml}
                    </div>

                    <div class="clinical-only">
                        <div class="section-title">üå¨Ô∏è Airway & Fluids</div>
                        <div class="grid-3">
                            <div class="data-box"><div class="lbl">ETT</div><div class="val">${calcs.ett}</div></div>
                            <div class="data-box"><div class="lbl">Depth</div><div class="val">${calcs.depth} cm</div></div>
                            <div class="data-box"><div class="lbl">Blade</div><div class="val">${calcs.blade}</div></div>
                            
                            <div class="data-box"><div class="lbl">1st Hr</div><div class="val">${fmtNum(calcs.rate1st)} ml</div><span class="drops-text">${getDripRate(calcs.rate1st)}</span></div>
                            <div class="data-box"><div class="lbl">2nd Hr</div><div class="val">${fmtNum(calcs.rate2nd)} ml</div><span class="drops-text">${getDripRate(calcs.rate2nd)}</span></div>
                            <div class="data-box"><div class="lbl">3rd Hr</div><div class="val">${fmtNum(calcs.rate3rd)} ml</div><span class="drops-text">${getDripRate(calcs.rate3rd)}</span></div>
                        </div>

                        <div class="section-title">üíâ Drug Protocol</div>
                        <table>
                            <thead><tr><th style="width:50%">Drug</th><th style="width:30%">Dose</th><th style="width:20%; text-align:right">Vol</th></tr></thead>
                            <tbody>${drugRows}</tbody>
                        </table>
                        ${blockHtml}
                        ${safetyHtml}
                    </div>
                    </div>
            </div>`;
            cont.innerHTML += html;
        });
    }

    // --- SAVING ---
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = pdf.internal.pageSize.getHeight();
        const margin = 10;
        const printW = pdfW - (margin * 2);

        const cards = document.querySelectorAll('.patient-card');
        const header = document.getElementById('final-list-header');

        // Create Header Image Once
        const headerCanvas = await html2canvas(header, { scale: 2 });
        const hImg = headerCanvas.toDataURL('image/png');
        const hRatio = headerCanvas.height / headerCanvas.width;
        const hHeight = printW * hRatio;

        for(let i=0; i<cards.length; i++) {
            if (i > 0) pdf.addPage();

            // Add Header on every page
            pdf.addImage(hImg, 'PNG', margin, margin, printW, hHeight);

            // Add Patient
            const canvas = await html2canvas(cards[i], { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = pdf.getImageProperties(imgData);
            
            // Calculate height to fit without cropping
            let imgHeight = (imgProps.height * printW) / imgProps.width;
            
            // If card is extremely long (unlikely with this data, but possible), scale it down to fit one page
            const maxContentH = pdfH - (margin * 2) - hHeight - 20; // 20 for footer space
            if (imgHeight > maxContentH) {
                // Resize width to keep aspect ratio fit in height
                const scaleFactor = maxContentH / imgHeight;
                const newWidth = printW * scaleFactor;
                const centeringX = margin + (printW - newWidth) / 2;
                pdf.addImage(imgData, 'PNG', centeringX, margin + hHeight + 5, newWidth, maxContentH);
            } else {
                pdf.addImage(imgData, 'PNG', margin, margin + hHeight + 5, printW, imgHeight);
            }
            
            // Add Text Footer
            pdf.setFontSize(7);
            pdf.setTextColor(100);
            const footerText = "Medical Disclaimer: Lista App - Verify all doses. Dr. Abdow Whatsapp: +201550086024";
            pdf.text(footerText, pdfW / 2, pdfH - 10, { align: "center" });
        }
        
        pdf.save(`Anesthesia_List_${listMeta.date}.pdf`);
    }

    async function saveImage(mode) {
        const area = document.getElementById('capture-area');
        
        if (mode === 'nurse') {
            document.querySelectorAll('.clinical-only').forEach(el => el.style.display = 'none');
            document.getElementById('out-list-name').innerText += " (Management Copy)";
        }

        try {
            const canvas = await html2canvas(area, { scale: 2, useCORS: true });
            const link = document.createElement('a');
            link.download = `${listMeta.name.replace(/\s+/g, '_')}_${listMeta.date}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch (e) {
            alert("Error saving image.");
        } finally {
            if (mode === 'nurse') {
                document.querySelectorAll('.clinical-only').forEach(el => el.style.display = 'block');
                document.getElementById('out-list-name').innerText = listMeta.name;
            }
        }
    }
</script>
</body>
</html>
