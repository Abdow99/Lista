<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anesthesia Theater Coordinator Pro</title>
    <meta name="theme-color" content="#1a1a1a">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { 
            --primary: #ef233c;       
            --bg: #1a1a1a;            
            --card-bg: #2b2b2b;       
            --input-bg: #3d3d3d;
            --text-light: #f8f9fa;    
            --text-gray: #adb5bd;
            --highlight: #ffd166;
            --shadow: 0 4px 15px rgba(0,0,0,0.5);
            --border-radius: 12px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-light); 
            margin: 0; 
            padding: 20px 0; 
        }

        .container { width: 95%; max-width: 750px; margin: 0 auto; padding-bottom: 80px; }

        /* HEADER */
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }

        /* FORMS */
        .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: var(--input-bg); color: white; font-size: 1rem; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: 800; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; transition: 0.2s; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: #4361ee; }
        .btn-success { background: #2a9d8f; }
        .btn-danger { background: #d90429; }
        .btn-nurse { background: #f77f00; }
        button:active { transform: scale(0.98); }

        /* VIEWS */
        .view-section { display: none; }
        .active-view { display: block; }

        /* PATIENT CARD DESIGN (Abdowthesia Style) */
        .patient-card { 
            background: #ffffff; 
            color: #2b2d42; 
            border-radius: 10px; 
            margin-bottom: 30px; 
            overflow: hidden; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        .pc-header { 
            background: #e9ecef; padding: 10px 15px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: center;
        }
        .pc-num { font-weight: 900; font-size: 1.2rem; color: var(--primary); }
        .pc-actions button { padding: 5px 10px; font-size: 0.7rem; margin-left: 5px; }
        
        .pc-body { padding: 15px; }
        
        .highlight-data { font-size: 1.1rem; font-weight: 900; color: #000; margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .highlight-val { color: var(--primary); background: #fff3cd; padding: 0 4px; border-radius: 4px; }

        .notes-section { font-size: 0.85rem; margin: 10px 0; background: #ffe5e5; padding: 8px; border-radius: 6px; color: #d00000; font-weight: 700; display: none; }
        .requests-section { font-size: 0.85rem; margin: 5px 0; background: #e0fbfc; padding: 8px; border-radius: 6px; color: #0077b6; font-weight: 700; display: none; }

        /* CLINICAL GRIDS */
        .section-title { font-size: 0.8rem; font-weight: 800; color: #555; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 2px solid var(--primary); display: inline-block; }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
        .data-box { background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #dee2e6; }
        .lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; font-weight: 700; }
        .val { font-size: 0.95rem; font-weight: 800; color: #2b2d42; }
        .drops-text { font-size: 0.6rem; color: #e76f51; font-weight: 700; display: block; font-style: italic; }

        /* DRUG TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85rem; }
        th { text-align: left; font-size: 0.65rem; color: #666; background: #e9ecef; padding: 6px; text-transform: uppercase; }
        td { padding: 8px 4px; border-bottom: 1px solid #f1f3f5; color: #222; }
        .drug-name { font-weight: 800; display: block; }
        .drug-prep { font-size: 0.7rem; color: #666; }
        .vol-col { font-weight: 900; color: var(--primary); text-align: right; }
        
        /* Badges */
        .w-badge { font-size: 0.55rem; padding: 1px 4px; border-radius: 3px; font-weight: 800; margin-left: 4px; text-transform: uppercase; display: inline-block; }
        .w-tbw { background: #e9ecef; color: #495057; border: 1px solid #dee2e6; }
        .w-ibw { background: #e0fbfc; color: #0077b6; border: 1px solid #caf0f8; }
        .w-fixed { background: #f3e5f5; color: #7b1fa2; }
        
        .cat-row td { background: #f8f9fa; color: #2b2d42; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; padding: 4px 8px; border-left: 3px solid var(--primary); margin-top: 5px; }

        /* FINAL LIST HEADER */
        #final-list-header { background: #fff; color: #000; padding: 20px; text-align: center; border-bottom: 4px solid var(--primary); display: none; }
        #final-list-header h2 { margin: 0; font-size: 1.8rem; color: var(--primary); text-transform: uppercase; }
        #final-list-header p { margin: 5px 0 0 0; font-weight: 600; color: #555; }

        /* NURSE MODE HIDING */
        .nurse-hidden { display: block; } 
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Theater Coordinator</h1>
        <div id="status-bar" style="font-size: 0.8rem; color: #aaa;">Step 1: List Setup</div>
    </header>

    <div id="view-setup" class="view-section active-view">
        <div class="card">
            <div class="form-group">
                <label>List Name / Theater</label>
                <input type="text" id="listName" placeholder="e.g. OR 1 - General Surgery">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="listDate">
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Surgeons</label>
                        <input type="text" id="surgeons" placeholder="Dr. X, Dr. Y">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Anesthesiologists</label>
                        <input type="text" id="anesthetists" placeholder="Dr. Z">
                    </div>
                </div>
            </div>
            <button class="btn-primary" onclick="goToInput()">Start List</button>
        </div>
    </div>

    <div id="view-input" class="view-section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="font-size:1rem;">Patient Details</label>
                <span id="edit-indicator" style="color:var(--highlight); font-size:0.8rem; display:none;">EDITING MODE</span>
            </div>
            
            <input type="hidden" id="pId"> <div class="form-group">
                <label>Patient Name</label>
                <input type="text" id="pName">
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Age (Y)</label>
                        <input type="number" id="pAge" step="0.1" onchange="estimateWeight()">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="pWeight" step="0.1" placeholder="Auto-Est if empty">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Operation</label>
                <input type="text" id="pOp">
            </div>
            <div class="form-group">
                <label>Anesthesia Type</label>
                <select id="pType">
                    <option value="GA">General Anesthesia (GA)</option>
                    <option value="Spinal">Spinal</option>
                    <option value="Regional/Block">Regional / Nerve Block</option>
                    <option value="Sedation">Sedation</option>
                </select>
            </div>
            <div class="form-group">
                <label>Requests (Blood, Plasma, ICU, etc)</label>
                <input type="text" id="pRequests" placeholder="e.g. Prepare 2 units PRBCs">
            </div>
            <div class="form-group">
                <label>Positive Data / Allergies / Notes</label>
                <textarea id="pNotes" placeholder="Medical history, Difficult airway, Specific Block..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn-secondary" id="btnAddParam" onclick="addPatient()">‚ûï Add to List</button>
                <button class="btn-success" onclick="generateView()">‚úÖ Finish & View List</button>
            </div>
        </div>
        <div style="text-align:center; font-size:0.8rem; color:#888; margin-top:10px;">
            Current Patients: <span id="count-badge" style="color:white; font-weight:bold;">0</span>
        </div>
    </div>

    <div id="view-output" class="view-section">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn-primary" onclick="goToInput()">‚ûï Add More</button>
            <button class="btn-danger" onclick="location.reload()">üîÑ Reset All</button>
        </div>

        <div id="capture-area" style="background: #ffffff; padding: 0; border-radius: 5px;">
            
            <div id="final-list-header">
                <h2 id="out-list-name">Theater List</h2>
                <p><span id="out-date"></span> | <span id="out-team"></span></p>
                <p style="font-size:0.9rem; margin-top:5px; color:#ef233c;">Total Patients: <span id="out-count">0</span></p>
            </div>

            <div id="list-container" style="padding: 10px;"></div>

            <div style="text-align:center; padding:10px; font-size:0.6rem; color:#999; border-top:1px solid #eee;">
                Generated by Anesthesia Coordinator Pro. Verify all doses.
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <label>Saving Options</label>
            <div class="btn-group">
                <button class="btn-primary" onclick="saveImage('full')">üì∏ Save for Anesthesia (Full)</button>
            </div>
            <div class="btn-group" style="margin-top:10px;">
                <button class="btn-nurse" onclick="saveImage('nurse')">üìã Save for Management (No Drugs)</button>
            </div>
            <p style="font-size:0.7rem; color:#aaa; text-align:center; margin-top:5px;">
                "Management" version hides drugs, fluids & airway details.
            </p>
        </div>
    </div>
</div>

<script>
    // --- DATA STORE ---
    let listMeta = { name: "", date: "", surgeons: "", anesthetists: "" };
    let patients = [];
    let editMode = false;

    // --- INIT ---
    window.onload = function() {
        const tmr = new Date();
        tmr.setDate(tmr.getDate() + 1); // Default tomorrow
        document.getElementById('listDate').valueAsDate = tmr;
    };

    // --- NAVIGATION ---
    function goToInput() {
        listMeta.name = document.getElementById('listName').value || "Theater List";
        listMeta.date = document.getElementById('listDate').value;
        listMeta.surgeons = document.getElementById('surgeons').value;
        listMeta.anesthetists = document.getElementById('anesthetists').value;

        document.getElementById('view-setup').classList.remove('active-view');
        document.getElementById('view-output').classList.remove('active-view');
        document.getElementById('view-input').classList.add('active-view');
        document.getElementById('status-bar').innerText = "Step 2: Add Patients";
        
        // Reset form for new entry unless editing
        if(!editMode) clearForm();
    }

    function estimateWeight() {
        const age = parseFloat(document.getElementById('pAge').value);
        if(!age && age !== 0) return;
        let w = 0;
        if (age < 1) w = (age * 12 + 9) / 2; 
        else if (age <= 8) w = (age * 2) + 8;
        else if (age < 18) w = (age * 3) + 7;
        else w = 70;
        document.getElementById('pWeight').placeholder = `Est: ${w.toFixed(1)} kg`;
    }

    function clearForm() {
        document.getElementById('pId').value = "";
        document.getElementById('pName').value = "";
        document.getElementById('pAge').value = "";
        document.getElementById('pWeight').value = "";
        document.getElementById('pOp').value = "";
        document.getElementById('pRequests').value = "";
        document.getElementById('pNotes').value = "";
        document.getElementById('pWeight').placeholder = "Auto-Est if empty";
        document.getElementById('btnAddParam').innerText = "‚ûï Add to List";
        document.getElementById('btnAddParam').classList.remove('btn-success');
        document.getElementById('btnAddParam').classList.add('btn-secondary');
        document.getElementById('edit-indicator').style.display = 'none';
        editMode = false;
    }

    // --- CRUD OPERATIONS ---
    function addPatient() {
        const idVal = document.getElementById('pId').value;
        const name = document.getElementById('pName').value;
        const age = parseFloat(document.getElementById('pAge').value);
        let weight = parseFloat(document.getElementById('pWeight').value);
        const op = document.getElementById('pOp').value;
        const type = document.getElementById('pType').value;
        const req = document.getElementById('pRequests').value;
        const notes = document.getElementById('pNotes').value;

        if(!name || isNaN(age) || !op) {
            alert("Name, Age, and Operation are required.");
            return;
        }

        // Auto Calc Weight if empty
        let estimated = false;
        if (!weight) {
            estimated = true;
            if (age < 1) weight = (age * 12 + 9) / 2; 
            else if (age <= 8) weight = (age * 2) + 8;
            else if (age < 18) weight = (age * 3) + 7;
            else weight = 70;
        }

        const pObj = {
            id: idVal ? parseInt(idVal) : Date.now(),
            name, age, weight, estimated, op, type, req, notes
        };

        if(editMode && idVal) {
            // Update existing
            const idx = patients.findIndex(p => p.id == idVal);
            if(idx !== -1) patients[idx] = pObj;
            editMode = false;
        } else {
            // Add new
            patients.push(pObj);
        }

        clearForm();
        document.getElementById('count-badge').innerText = patients.length;
        document.getElementById('pName').focus();
    }

    function deletePatient(id) {
        if(confirm("Delete this patient?")) {
            patients = patients.filter(p => p.id !== id);
            generateView(); // Re-render list
        }
    }

    function editPatient(id) {
        const p = patients.find(obj => obj.id === id);
        if(!p) return;
        
        editMode = true;
        document.getElementById('view-output').classList.remove('active-view');
        document.getElementById('view-input').classList.add('active-view');

        document.getElementById('pId').value = p.id;
        document.getElementById('pName').value = p.name;
        document.getElementById('pAge').value = p.age;
        document.getElementById('pWeight').value = p.weight;
        document.getElementById('pOp').value = p.op;
        document.getElementById('pType').value = p.type;
        document.getElementById('pRequests').value = p.req;
        document.getElementById('pNotes').value = p.notes;
        
        document.getElementById('btnAddParam').innerText = "üíæ Update Patient";
        document.getElementById('btnAddParam').classList.remove('btn-secondary');
        document.getElementById('btnAddParam').classList.add('btn-success');
        document.getElementById('edit-indicator').style.display = 'inline';
    }

    // --- LOGIC ENGINE (Abdowthesia Port) ---
    function getDripRate(mlPerHour) {
        if (!mlPerHour || mlPerHour <= 0) return "--";
        const dropsPerSec = (mlPerHour * 15) / 3600;
        if (dropsPerSec >= 1) return `${dropsPerSec.toFixed(1)} gtt/s`;
        else return `1 gtt / ${(1/dropsPerSec).toFixed(0)}s`;
    }

    function calculate(p) {
        const w = p.weight;
        const age = p.age;
        
        // Weight Definitions
        let ibw = 70;
        if (age < 1) ibw = (age * 12 + 9) / 2;
        else if (age <= 8) ibw = (age * 2) + 8;
        else if (age < 18) ibw = (age * 3) + 7;
        
        const isObese = (w > ibw * 1.3 && age >= 12);
        const abw = isObese ? (ibw + 0.4 * (w - ibw)) : w;
        
        const w_ind = isObese ? abw : w;
        const w_nmb = isObese ? ibw : w;

        // Airway Logic (Abdowthesia)
        let ettVal, bladeText;
        if (age < 0.1) { ettVal = "2.5"; bladeText = "Miller 0"; }
        else if (age < 0.5) { ettVal = "3.0"; bladeText = "Miller 0/1"; }
        else if (age < 1.0) { ettVal = "3.5"; bladeText = "Mac 1"; }
        else if (age < 2.0) { ettVal = "4.0"; bladeText = "Mac 1/2"; }
        else if (age <= 10.0) { ettVal = ((age/4)+4).toFixed(1); bladeText = "Mac 2/3"; }
        else if (age < 18.0) { ettVal = "6.5-7.0"; bladeText = "Mac 3"; }
        else { ettVal = "7.0(F) / 7.5(M)"; bladeText = "Mac 3/4"; }

        let depthVal = (age < 1) ? (w + 6).toFixed(1) : (age >= 18 ? "21-23" : (((age/4)+4)*3).toFixed(0));

        // Fluid Logic
        let maint = (w <= 10) ? (w * 4) : (w <= 20 ? (40 + (w-10)*2) : (60 + (w-20)));
        let deficit = maint * 6;
        let rate1st = maint + (deficit/2);

        // Drugs Logic
        let drugs = [];
        
        const isGA = p.type === 'GA';
        const isSedation = p.type === 'Sedation';
        const isBlock = p.type === 'Spinal' || p.type.includes('Block') || p.type.includes('Regional');

        // Propofol
        if (!isBlock) {
             // Sedation: 1mg/kg, GA Child: 3mg/kg, GA Adult: 2mg/kg
            let pFactor = isSedation ? 1.0 : (age < 12 ? 3 : 2);
            let pDose = (isSedation ? w : (age < 12 ? w : w_ind)) * pFactor;
            let pLabel = isSedation ? "Propofol (Sedation)" : "Propofol";
            drugs.push({cat: "Induction", name: pLabel, prep: "10mg/mL", dose: pDose, unit: "mg", ml: pDose/10, badge: isSedation ? "TBW" : (age<12?"TBW":"ABW")});
        }

        // NMB & Induction (Only GA)
        if (isGA) {
            drugs.push({cat: "Induction", name: "Fentanyl", prep: "10mcg/mL", dose: w*1.5, unit: "mcg", ml: (w*1.5)/10, badge: "TBW"});
            drugs.push({cat: "Induction", name: "Atracurium", prep: "5mg/mL", dose: w_nmb*0.5, unit: "mg", ml: (w_nmb*0.5)/5, badge: isObese?"IBW":"TBW"});
            drugs.push({cat: "Induction", name: "Rocuronium", prep: "10mg/mL", dose: w_nmb*0.6, unit: "mg", ml: (w_nmb*0.6)/10, badge: isObese?"IBW":"TBW"});
        } else if (isSedation) {
             drugs.push({cat: "Induction", name: "Fentanyl", prep: "10mcg/mL", dose: w*1, unit: "mcg", ml: (w*1)/10, badge: "TBW"});
        }

        // Common Drugs (Everyone)
        let dexDose = (age >= 18) ? 8 : Math.min(w*0.15, 10);
        let dexConc = (age >= 18) ? 8 : 4;
        drugs.push({cat: "Co-Analgesia", name: "Dexamethasone", prep: `${dexConc}mg/mL`, dose: dexDose, unit: "mg", ml: dexDose/dexConc, badge: "Fixed"});
        
        let paraDose = Math.min(w*15, 1000);
        drugs.push({cat: "Co-Analgesia", name: "Paracetamol", prep: "10mg/mL", dose: paraDose, unit: "mg", ml: paraDose/10, badge: "TBW"});

        // Emergency / Reversal
        if (isGA) {
             let neoDose = Math.min(ibw*0.05, 5);
             drugs.push({cat: "Reversal", name: "Neostigmine", prep: "2.5mg/10mL", dose: neoDose, unit: "mg", ml: neoDose/0.25, badge: "IBW"});
             drugs.push({cat: "Reversal", name: "Atropine", prep: "0.1mg/mL", dose: Math.max(neoDose*0.4, 0.1), unit: "mg", ml: (Math.max(neoDose*0.4, 0.1))/0.1, badge: "Mix"});
        }

        let ephDose = Math.min(ibw*0.1, 6);
        drugs.push({cat: "Emergency", name: "Ephedrine", prep: "3mg/mL (Diluted)", dose: ephDose, unit: "mg", ml: ephDose/3, badge: "Max IBW"});
        
        let adrDose = (age >= 12) ? 0.025 : (w*0.001); // 25mcg adult, 1mcg/kg child
        drugs.push({cat: "Emergency", name: "Adrenaline", prep: "0.1mg/mL", dose: adrDose, unit: "mg", ml: adrDose/0.1, badge: "Rescue"});

        // Local Anesthetic Limits
        let lidoMax = ibw * 3;
        let marcMax = ibw * 2;

        return {
            ett: ettVal, blade: bladeText, depth: depthVal,
            maint: maint, rate1st: rate1st,
            drugs: drugs,
            lidoMax, marcMax
        };
    }

    // --- VIEW GENERATION ---
    function generateView() {
        document.getElementById('view-input').classList.remove('active-view');
        document.getElementById('view-output').classList.add('active-view');

        // Sorting Logic: Peds/Allergies first
        patients.sort((a, b) => {
            let sA = 0, sB = 0;
            if(a.age < 12) sA += 10;
            if(b.age < 12) sB += 10;
            if((a.notes+a.req).toLowerCase().includes('allergy')) sA += 5;
            if((b.notes+b.req).toLowerCase().includes('allergy')) sB += 5;
            return sB - sA;
        });

        // Header Update
        document.getElementById('final-list-header').style.display = 'block';
        document.getElementById('out-list-name').innerText = listMeta.name;
        document.getElementById('out-date').innerText = listMeta.date;
        document.getElementById('out-team').innerText = `Surgeons: ${listMeta.surgeons} | Anesthesia: ${listMeta.anesthetists}`;
        document.getElementById('out-count').innerText = patients.length;

        const cont = document.getElementById('list-container');
        cont.innerHTML = "";

        patients.forEach((p, idx) => {
            const calcs = calculate(p);
            
            // Build Drug Rows
            let lastCat = "";
            let drugRows = calcs.drugs.map(d => {
                let catHeader = "";
                if (d.cat !== lastCat) {
                    catHeader = `<tr class="cat-row"><td colspan="3">${d.cat}</td></tr>`;
                    lastCat = d.cat;
                }
                return `${catHeader}
                <tr>
                    <td><span class="drug-name">${d.name}</span> <span class="drug-prep">${d.prep}</span></td>
                    <td>${d.dose.toFixed(2)} ${d.unit} <span class="w-badge w-${d.badge.toLowerCase().includes('ibw')?'ibw':'tbw'}">${d.badge}</span></td>
                    <td class="vol-col">${d.ml.toFixed(1)} mL</td>
                </tr>`;
            }).join('');

            // Safety Limits embedded
            let safetyHtml = `
            <div style="margin-top:5px; font-size:0.75rem; background:#fff0f3; padding:5px; border-radius:4px; border:1px solid #ffccd5;">
                <strong>‚ö†Ô∏è Max Safety Limits (IBW):</strong> 
                Lidocaine: ${calcs.lidoMax.toFixed(0)}mg | Marcaine: ${calcs.marcMax.toFixed(0)}mg
            </div>`;

            // Block Note check
            let blockNote = "";
            const combinedNotes = (p.notes + " " + p.type).toLowerCase();
            if (combinedNotes.includes('supraclav')) blockNote = `<div style="background:#e0fbfc; padding:5px; margin-top:5px; color:#0077b6; font-weight:bold; font-size:0.8rem;">üíâ Supraclavicular Block: Suggest 20-25ml 0.5% Marcaine (Echo Guided)</div>`;
            else if (combinedNotes.includes('spinal')) blockNote = `<div style="background:#e0fbfc; padding:5px; margin-top:5px; color:#0077b6; font-weight:bold; font-size:0.8rem;">üíâ Spinal: Heavy Marcaine 0.5%</div>`;

            // HTML Construction
            const html = `
            <div class="patient-card">
                <div class="pc-header">
                    <div>
                        <span class="pc-num">#${idx+1}</span> 
                        <span style="font-weight:800; font-size:1.1rem; margin-left:8px;">${p.name}</span>
                    </div>
                    <div class="pc-actions" data-html2canvas-ignore>
                        <button class="btn-secondary" onclick="editPatient(${p.id})">EDIT</button>
                        <button class="btn-danger" onclick="deletePatient(${p.id})">DEL</button>
                    </div>
                </div>
                
                <div class="pc-body">
                    <div class="highlight-data">
                        <span class="highlight-val">${p.age} Y</span> | 
                        <span class="highlight-val">${p.weight} kg ${p.estimated?'(Est)':''}</span> | 
                        <span style="color:#ef233c;">${p.op}</span>
                        <div style="font-size:0.8rem; color:#555; margin-top:4px;">${p.type}</div>
                    </div>

                    ${p.req ? `<div class="requests-section" style="display:block">üîî REQUEST: ${p.req}</div>` : ''}
                    ${p.notes ? `<div class="notes-section" style="display:block">‚ö†Ô∏è NOTE: ${p.notes}</div>` : ''}

                    <div class="clinical-only">
                        <div class="section-title">üå¨Ô∏è Airway & Fluids</div>
                        <div class="grid-3">
                            <div class="data-box"><div class="lbl">ETT</div><div class="val">${calcs.ett}</div></div>
                            <div class="data-box"><div class="lbl">Depth</div><div class="val">${calcs.depth} cm</div></div>
                            <div class="data-box"><div class="lbl">Blade</div><div class="val">${calcs.blade}</div></div>
                            <div class="data-box"><div class="lbl">Maint.</div><div class="val">${calcs.maint.toFixed(0)} ml/h</div><span class="drops-text">${getDripRate(calcs.maint)}</span></div>
                            <div class="data-box"><div class="lbl">1st Hr</div><div class="val">${calcs.rate1st.toFixed(0)} ml</div><span class="drops-text">${getDripRate(calcs.rate1st)}</span></div>
                            <div class="data-box"><div class="lbl">NPO Def</div><div class="val">${(calcs.maint*6).toFixed(0)} ml</div></div>
                        </div>

                        <div class="section-title">üíâ Drug Protocol</div>
                        <table>
                            <thead><tr><th style="width:50%">Drug</th><th style="width:30%">Dose</th><th style="width:20%; text-align:right">Vol</th></tr></thead>
                            <tbody>${drugRows}</tbody>
                        </table>
                        ${safetyHtml}
                        ${blockNote}
                    </div>
                    </div>
            </div>`;
            cont.innerHTML += html;
        });
    }

    // --- SAVING ---
    async function saveImage(mode) {
        const area = document.getElementById('capture-area');
        
        // Handle Nurse Mode (Hide clinical details)
        if (mode === 'nurse') {
            document.querySelectorAll('.clinical-only').forEach(el => el.style.display = 'none');
            document.getElementById('out-list-name').innerText += " (Management Copy)";
        }

        try {
            const canvas = await html2canvas(area, { scale: 2, useCORS: true });
            const link = document.createElement('a');
            link.download = `${listMeta.name.replace(/\s+/g, '_')}_${listMeta.date}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch (e) {
            alert("Error saving image.");
        } finally {
            // Restore view
            if (mode === 'nurse') {
                document.querySelectorAll('.clinical-only').forEach(el => el.style.display = 'block');
                document.getElementById('out-list-name').innerText = listMeta.name;
            }
        }
    }
</script>
</body>
</html>